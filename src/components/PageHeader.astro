---
import { Avatar, Breadcrumbs, BreadcrumbsItem, Heading, Link, Button } from 'accessible-astro-components'
import { Image } from 'astro:assets'
import sanitizeHtml from 'sanitize-html'

/**
 * PageHeader Component
 *
 * @description PageHeader description
 */
interface Props {
  /**
   * Additional classes to apply to the PageHeader
   */
  class?: string
  /**
   * The featured image of the page
   */
  featuredImage?: string
  /**
   * The second featured image of the page
   */
  featuredImage2?: string
  /**
   * The width of the second featured image
   */
  featuredImageWidth?: number
  /**
   * The title of the page
   */
  title: string
  /**
   * The subtitle of the page
   * @description Can contain HTML content (will be sanitized)
   */
  subtitle?: string
  /**
   * The background color of the page header
   * @type {'primary' | 'secondary' | 'neutral' | 'gradient' | 'bordered' | undefined}
   * @default undefined - Uses the default background color
   */
  /**
   * The author of the page
   */
  author?: {
    name: string
    image: string
    bio: string
  }
  bgType?: 'primary' | 'secondary' | 'neutral' | 'gradient' | 'bordered'
  /**
   * Whether to show the breadcrumbs
   */
  showBreadcrumbs?: boolean
  /**
   * Custom breadcrumb labels to override the default URL-based labels
   * @description Object mapping URL segments to their display labels
   */
  customBreadcrumbLabels?: Record<string, string>
  /**
   * The keypoints of the page
   */
  keypoints?: string[]
  /**
   * The stack of the page
   */
  stack?: string[]
  /**
   * The GitHub link of the page
   */
  github?: string
  /**
   * The live link of the page
   */
  live?: string
  /**
   * The download link of the page
   */
  download?: string
  /**
   * Whether to join the last breadcrumb
   */
  joinLastBreadcrumb?: boolean
  /**
   * The collaborators of the page
   */
  collaborators?: string[]
  /**
   * The links of the page
   */
  links?: { href: string; label: string }[]
}

const {
  class: className,
  title,
  subtitle,
  bgType,
  showBreadcrumbs = true,
  featuredImage,
  featuredImage2,
  featuredImageWidth = 380,
  author,
  customBreadcrumbLabels,
  joinLastBreadcrumb = false,
  keypoints,
  stack,
  github,
  live,
  download,
  collaborators,
  links,
} = Astro.props

// Helper function to format segment names
const formatSegment = (segment: string): string => {
  if (customBreadcrumbLabels?.[segment]) {
    return customBreadcrumbLabels[segment]
  }
  return segment
    .split('-')
    .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
    .join(' ')
}

// Sanitize subtitle HTML if present
const sanitizedSubtitle: string = subtitle
  ? sanitizeHtml(subtitle, {
      allowedTags: ['b', 'i', 'em', 'strong', 'a', 'span', 'br'],
      allowedAttributes: {
        a: ['href', 'title', 'target', 'rel'],
        span: ['class'],
      },
    })
  : ''
---

<section class:list={[className, 'page-header']}>
  <div class="container my-3">
    {
      showBreadcrumbs &&
        (() => {
          const path = Astro.url.pathname
          const segments = path.split('/').filter(Boolean)

          if (segments.length === 0) {
            return null
          }

          return (
            <Breadcrumbs>
              <BreadcrumbsItem href="/" label="Home" />
              {segments.map((segment, index) => {
                if (joinLastBreadcrumb && index === segments.length - 1) {
                  return null
                }

                const url = `/${segments.slice(0, index + 1).join('/')}`
                const isLast = index === segments.length - 1 || (joinLastBreadcrumb && index === segments.length - 2)

                const formattedName = (() => {
                  if (joinLastBreadcrumb && isLast) {
                    const prevSegment = segments[segments.length - 2]
                    const lastSegment = segments[segments.length - 1]
                    return `${formatSegment(prevSegment)}: ${formatSegment(lastSegment)}`
                  }

                  return formatSegment(segment)
                })()

                return <BreadcrumbsItem href={isLast ? undefined : url} label={formattedName} currentPage={isLast} />
              })}
            </Breadcrumbs>
          )
        })()
    }
  </div>
  <div class:list={['py-16', bgType && `bg-${bgType}`]}>
    <div class="space-content container">
      <!-- {
        featuredImage && (
          <div class="featured-image-container mb-8">
            <Image
              src={featuredImage}
              alt=""
              width={1200}
              height={250}
              class="h-[250px] w-full rounded-lg object-cover"
            />
          </div>
        )
      } -->
      <div class="grid grid-cols-1 gap-4 md:grid-cols-2 md:gap-16">
        <div class="order-2 flex flex-col justify-center md:order-1">
          <h1 class="leading-none">{title}</h1>
          {sanitizedSubtitle && <p class="mt-4 text-2xl" set:html={sanitizedSubtitle} />}
        </div>

        {
          featuredImage2 && (
            <div class="order-1 mr-0 mb-8 flex justify-center sm:-mr-5 md:order-2 md:justify-end xl:-mr-18">
              <Image
                src={featuredImage2}
                alt=""
                width={featuredImageWidth}
                height={250}
                class="object-cover"
                class="rounded-lg"
              />
            </div>
          )
        }
      </div>
      {
        keypoints && (
          <p class="flex flex-wrap gap-4">
            {keypoints.map((keypoint, index) => (
              <>
                <span>{keypoint}</span>
                {index !== keypoints.length - 1 && <span class="text-neutral-500">Â·</span>}
              </>
            ))}
          </p>
        )
      }
      {
        stack && (
          <p class="flex flex-wrap gap-4">
            Built with {stack.slice(0, -1).join(', ')} and {stack[stack.length - 1]}{' '}
            {collaborators?.length ? `together with ${collaborators.join(', ')}` : null}.
          </p>
        )
      }
      {
        author && (
          <div class="mt-6 flex items-center">
            <Avatar title={author.name} image={author.image} subtitle={author.bio} />
          </div>
        )
      }
      <div class="flex flex-wrap gap-4">
        {
          github && (
            <Link href={github} target="_blank">
              GitHub
            </Link>
          )
        }
        {
          live && (
            <Link href={live} target="_blank">
              Live
            </Link>
          )
        }
        {
          download && (
            <Link href={download} target="_blank">
              Download
            </Link>
          )
        }
        {
          links && (
            <div class="flex flex-wrap gap-4">
              {links.map((link) => (
                <Link href={link.href} target="_blank">
                  {link.label}
                </Link>
              ))}
            </div>
          )
        }
      </div>
    </div>
  </div>
</section>

<style>
  .page-header {
    .bg-primary {
      background-color: light-dark(var(--color-primary-100), var(--color-primary-500));
    }

    .bg-secondary {
      background-color: light-dark(var(--color-secondary-100), var(--color-secondary-500));
    }

    .bg-neutral {
      background-color: light-dark(var(--color-neutral-300), var(--color-neutral-800));
    }

    .bg-gradient {
      background-image: linear-gradient(
        315deg,
        light-dark(var(--color-primary-100), var(--color-secondary-100)) 25%,
        light-dark(var(--color-secondary-100), var(--color-primary-200))
      );
      color: var(--color-neutral-900);
    }

    .bg-bordered {
      border: 1px solid var(--border-color-subtle);
      border-inline: 0;
    }

    .featured-image-container {
      max-height: 500px;
      overflow: hidden;
    }
  }
</style>
